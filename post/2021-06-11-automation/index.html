<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automate all the things | hiepph</title><meta name=keywords content><meta name=description content="It&rsquo;s been a while since my last post.
So FVI used to be a single service specific for reading ID card information. But now, it&rsquo;s growing to a multi-service platform with tons of other form-constraint documents. The process is still the same. We have to duplicate it many more times in a much faster and efficient way. The problem is turning to automation.
My team and I have been pondering many more technologies outside of the machine learning world to tackle the problem."><meta name=author content><link rel=canonical href=https://hiepph.github.io/post/2021-06-11-automation/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2d6dbfc6e0f8a1db1c9d082a76dc11d094328cf63f247bbc2421dfaa7f2bb170.css integrity="sha256-LW2/xuD4odscnQgqdtwR0JQyjPY/JHu8JCHfqn8rsXA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://hiepph.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hiepph.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hiepph.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hiepph.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hiepph.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><meta property="og:title" content="Automate all the things"><meta property="og:description" content="It&rsquo;s been a while since my last post.
So FVI used to be a single service specific for reading ID card information. But now, it&rsquo;s growing to a multi-service platform with tons of other form-constraint documents. The process is still the same. We have to duplicate it many more times in a much faster and efficient way. The problem is turning to automation.
My team and I have been pondering many more technologies outside of the machine learning world to tackle the problem."><meta property="og:type" content="article"><meta property="og:url" content="https://hiepph.github.io/post/2021-06-11-automation/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-06-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automate all the things"><meta name=twitter:description content="It&rsquo;s been a while since my last post.
So FVI used to be a single service specific for reading ID card information. But now, it&rsquo;s growing to a multi-service platform with tons of other form-constraint documents. The process is still the same. We have to duplicate it many more times in a much faster and efficient way. The problem is turning to automation.
My team and I have been pondering many more technologies outside of the machine learning world to tackle the problem."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://hiepph.github.io/post/"},{"@type":"ListItem","position":3,"name":"Automate all the things","item":"https://hiepph.github.io/post/2021-06-11-automation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Automate all the things","name":"Automate all the things","description":"It\u0026rsquo;s been a while since my last post.\nSo FVI used to be a single service specific for reading ID card information. But now, it\u0026rsquo;s growing to a multi-service platform with tons of other form-constraint documents. The process is still the same. We have to duplicate it many more times in a much faster and efficient way. The problem is turning to automation.\nMy team and I have been pondering many more technologies outside of the machine learning world to tackle the problem.","keywords":[],"articleBody":"It’s been a while since my last post.\nSo FVI used to be a single service specific for reading ID card information. But now, it’s growing to a multi-service platform with tons of other form-constraint documents. The process is still the same. We have to duplicate it many more times in a much faster and efficient way. The problem is turning to automation.\nMy team and I have been pondering many more technologies outside of the machine learning world to tackle the problem. So I thought, why I don’t share some practices I learn along the way. This post is more related to DevOps and technology choice decision.\nAnsible The first thing I look into is how we can bootstrap the platform quickly and efficiently. Ansible suits our need.\nIn a nutshell, Ansible is a tool for configuration management. I bootstrap what packages I need, what process to run to properly set up a brand new server to support our platform architecture. You can think of a bash script file, but written in YAML and is run remotely from your local machine through SSH.\nFor example, I need to set up Docker and Docker-compose and some necessary directories for the platform on a Ubuntu server.\nThe sample code for setting up docker would be (setup.yaml):\n- name: Set up docker gather_facts: no hosts: all tags: docker become: yes tasks: - name: Install aptitude using apt apt: name=aptitude state=latest update_cache=yes force_apt_get=yes - name: Install required system packages apt: name={{ item }} state=present update_cache=yes loop: ['apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common', 'python3-pip', 'virtualenv', 'python3-setuptools'] - name: Add Docker GPG apt Key apt_key: url: https://download.docker.com/linux/ubuntu/gpg state: present - name: Add Docker Repository apt_repository: repo: deb https://download.docker.com/linux/ubuntu bionic stable state: present - name: Update apt and install docker-ce apt: update_cache=yes name=docker-ce state=present - name: Install Docker Compose pip: name: docker-compose - name: Add user to docker group shell: usermod -aG docker {{ ansible_user }} The code is self-explanatory. Ansible urges us to switch to the mindset of treating our infrastructure as code. Scripts are managed with version control, have documentation and contribution between team members.\nI can manage my servers through a hosts file (/etc/ansible/hosts):\n[local] localhost ansible_connection=local [prod]  ansible_user=hiepph  ansible_user=hiepph Then I can quickly run the below command to set up docker, and docker-compose on both servers that matched the group prod. With the support of idempotence, I can limit the side effects in installing process. No sweat!\nansible-playbook setup.yaml -l prod -t docker Ansible provides thousand of plugins, and I use one to manage cron jobs efficiently. For example, I manage the repeated tasks of backup, clearing temporary data or cache, etc. A concept using rclone to backup hourly is demonstrated below.\n- name: backup concept using rclone cron: special_time: \"hourly\" name: \"backup the precious ring\" job: \"rclone copy /precious/ backup-cloud:/precious\" CI/CD There are several significant reasons to bring CI/CD to the table.\nWe have to do the same thing over and over again: building the image, deploy the new build to the production, pulling new models, etc. These repetitive tasks suck. They drain your energy from thinking what the script for this task, which documentation and the process you have to look into before doing anything. The mantra is Define then Forget. You define the automation process (script) then forget all about it to reserver energy for other tasks.\nHuman resource is valuable. The brain is for ideas, not for storage. So be wise where to put energy.\nIt’s normal for human to make mistakes. However, with a predefined process, the machine is much less likely to make a mistake. Here you contain the problem into a box and know where to look for when the bugs happen.\nOne huge benefit we notice immediately is the velocity of deployment, both in staging and production environment.\nFor example, I define the following deploy process:\n A member writes a new feature. He first runs the local test, then submits a merge request on the repository. After merging code, he proceeds to tag a version to deploy. When the process is triggered, it first builds a new image with the same tag. Next, the image is deployed in a test environment. The test is then triggered. If any bug happens, the process fails. So the member has to fix it and repeat the process. Otherwise, the build is deployed in the staging/production environment depending on the tag’s pattern.  To achieve the CI/CD pipeline, I utilize the Gitlab Runner on our self-hosted Gitlab. I’m still in awe of how easy to adopt CI/CD using Gitlab. Kudos to the team!\nTo set up CI/CD, you can follow the Gitlab Runner’s installation guide. Or you can use Ansible role to easily set one up. I prefer the latter since we have many servers to manage.\nFirst the requirement (requirements.yaml):\nroles: - riemers.gitlab-runner Then you can use ansible-galaxy to install the role:\nansible-galaxy install -r requirements.yml A sample playbook (gitlab.yaml):\n- name: Setup Gitlab Runner hosts: all become: yes vars_files: - vars/runner.yaml roles: - { role: riemers.gitlab-runner } tasks: - name: add gitlab-runner to groups shell: usermod -aG {{ item }} gitlab-runner with_items: - {{ ansible_user }} - docker Inside vars, I provide some tokens and settings:\ngitlab_runner_coordinator_url: \"\" gitlab_runner_registration_token: \"\" gitlab_runner_runners: - name: \"ocr-prod\" executor: \"shell\" state: \"present\" tags: - prod docker_privileged: true Then one command to set up:\nansible-playbook gitlab.yml -l prod Now my main job is to maintain the .gitlab-ci.yml file to define the pipeline. Below is the concept code:\nvariables: IMAGE:  TEST_DIR:  STAGING_DIR:  PROD_DIR:  stages: - build - test - deploy build: stage: build script: - docker build . -t $IMAGE:$CI_COMMIT_TAG - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY - docker push $IMAGE:$CI_COMMIT_TAG test: stage: test script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY - docker pull $IMAGE:$CI_COMMIT_TAG - cd $TEST_DIR - docker-compose up -d - pytest - docker-compose down staging: stage: deploy script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY - docker pull $IMAGE:$CI_COMMIT_TAG - cd $STAGING_DIR - docker-compose up -d prod: stage: deploy script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY - docker pull $IMAGE:$CI_COMMIT_TAG - cd $PROD_DIR - docker-compose up -d The variables with $CI_ prefix are predefined variables of our self-hosted Gitlab code base and image registry. There are many more predefined variables to support you for the automation process.\nWith the simple act of tagging, we can achieve 5-10 releases a day. That’s a massive step since we used to release weekly, and the process required various members to join.\nDue to the policy, I can only reveal the concept and some of our code. However, I hope with the mindset and these tools; you can adapt automation to your team and daily life.\n","wordCount":"1122","inLanguage":"en","datePublished":"2021-06-11T00:00:00Z","dateModified":"2021-06-11T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://hiepph.github.io/post/2021-06-11-automation/"},"publisher":{"@type":"Organization","name":"hiepph","logo":{"@type":"ImageObject","url":"https://hiepph.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://hiepph.github.io accesskey=h title="hiepph (Alt + H)">hiepph</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Automate all the things</h1><div class=post-meta>June 11, 2021</div></header><div class=post-content><p>It&rsquo;s been a while since my last post.</p><p>So <a href=/post/2018-11-13-ocr>FVI</a> used to be a single service specific for reading ID card
information. But now, it&rsquo;s growing to a multi-service platform with
tons of other form-constraint documents. The process is still the
same. We have to duplicate it many more times in a much
faster and efficient way. The problem is turning to automation.</p><p>My team and I have been pondering many more technologies outside of the machine learning world to tackle the problem.
So I thought, why I don&rsquo;t share some practices I learn along the way.
This post is more related to DevOps and technology choice decision.</p><h1 id=ansible>Ansible<a hidden class=anchor aria-hidden=true href=#ansible>#</a></h1><p>The first thing I look into is how we can bootstrap the platform
quickly and efficiently. <a href=https://www.ansible.com/>Ansible</a> suits our need.</p><p>In a nutshell, Ansible is a tool for configuration management.
I bootstrap what packages I need, what process to run to properly set
up a brand new server to support our platform architecture.
You can think of a bash script file, but written in YAML and is run remotely from your local machine through SSH.</p><p>For example, I need to set up Docker and Docker-compose and some
necessary directories for the platform on a Ubuntu server.</p><p><img loading=lazy src=/automation/ansible.png alt=ansible></p><p>The sample code for setting up docker would be (<code>setup.yaml</code>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set up docker</span>
  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
  <span style=color:#f92672>tags</span>: <span style=color:#ae81ff>docker</span>
  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install aptitude using apt</span>
      <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name=aptitude state=latest update_cache=yes force_apt_get=yes</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install required system packages</span>
      <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>name={{ item }} state=present update_cache=yes</span>
      <span style=color:#f92672>loop</span>: [<span style=color:#e6db74>&#39;apt-transport-https&#39;</span>, <span style=color:#e6db74>&#39;ca-certificates&#39;</span>, <span style=color:#e6db74>&#39;curl&#39;</span>, <span style=color:#e6db74>&#39;software-properties-common&#39;</span>, <span style=color:#e6db74>&#39;python3-pip&#39;</span>, <span style=color:#e6db74>&#39;virtualenv&#39;</span>, <span style=color:#e6db74>&#39;python3-setuptools&#39;</span>]

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add Docker GPG apt Key</span>
      <span style=color:#f92672>apt_key</span>:
        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://download.docker.com/linux/ubuntu/gpg</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add Docker Repository</span>
      <span style=color:#f92672>apt_repository</span>:
        <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>deb https://download.docker.com/linux/ubuntu bionic stable</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Update apt and install docker-ce</span>
      <span style=color:#f92672>apt</span>: <span style=color:#ae81ff>update_cache=yes name=docker-ce state=present</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Docker Compose</span>
      <span style=color:#f92672>pip</span>:
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>docker-compose</span>

    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add user to docker group</span>
      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>usermod -aG docker {{ ansible_user }}</span>
</code></pre></div><p>The code is self-explanatory. Ansible urges us to
switch to the mindset of treating our <strong>infrastructure as code</strong>.
Scripts are managed with version control, have documentation and contribution between team members.</p><p>I can manage my servers through a hosts file (<code>/etc/ansible/hosts</code>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>[local]
localhost    ansible_connection=local

[prod]
&lt;ip1&gt;    ansible_user=hiepph
&lt;ip2&gt;    ansible_user=hiepph
</code></pre></div><p>Then I can quickly run the below command to set up <code>docker</code>, and
<code>docker-compose</code> on both servers that matched the <code>group</code> prod.
With the support of <a href=https://en.wikipedia.org/wiki/Idempotence>idempotence</a>,
I can limit the side effects in installing process. No sweat!</p><pre><code>ansible-playbook setup.yaml -l prod -t docker
</code></pre><p>Ansible provides thousand of plugins, and I use one to manage cron jobs efficiently.
For example, I manage the repeated tasks of backup, clearing temporary data or cache, etc.
A concept using <code>rclone</code> to backup hourly is demonstrated below.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>backup concept using rclone</span>
  <span style=color:#f92672>cron</span>:
    <span style=color:#f92672>special_time</span>: <span style=color:#e6db74>&#34;hourly&#34;</span>
    <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;backup the precious ring&#34;</span>
    <span style=color:#f92672>job</span>: <span style=color:#e6db74>&#34;rclone copy /precious/ backup-cloud:/precious&#34;</span>
</code></pre></div><h1 id=cicd>CI/CD<a hidden class=anchor aria-hidden=true href=#cicd>#</a></h1><p><img loading=lazy src=https://raw.githubusercontent.com/RogueDudes/roguedudes.github.io/master/assets/images/automate.jpg alt=automate></p><p>There are several significant reasons to bring <a href=https://www.wikiwand.com/en/CI/CD>CI/CD</a> to the table.</p><p>We have to do the same thing over and over again: building the image, deploy the new build to the production, pulling new models, etc. These repetitive tasks suck. They drain your energy from thinking what the script for this task, which documentation and
the process you have to look into before doing anything.
The mantra is <strong>Define then Forget</strong>. You define the automation
process (script) then forget all about it to reserver energy for other tasks.</p><p>Human resource is valuable. The brain is for ideas, not for storage. So be
wise where to put energy.</p><p>It&rsquo;s normal for human to make mistakes. However, with a predefined
process, the machine is much less likely to make a mistake.
Here you contain the problem into a box and know where to look for
when the bugs happen.</p><p>One huge benefit we notice immediately is the velocity of deployment, both in staging and production environment.</p><p><img loading=lazy src=/automation/ci-cd.png alt=ci-cd></p><p>For example, I define the following deploy process:</p><ol><li>A member writes a new feature. He first runs the local test, then submits a merge request on the repository. After merging code, he proceeds to tag a version to deploy.</li><li>When the process is triggered, it first builds a new image with the same tag. Next, the image is deployed in a test environment. The test is then triggered. If any bug happens, the process fails. So the member has to fix it and repeat the process. Otherwise, the build is deployed in the staging/production environment depending on the tag&rsquo;s pattern.</li></ol><p>To achieve the CI/CD pipeline, I utilize the <a href=https://docs.gitlab.com/runner/>Gitlab Runner</a> on our
self-hosted Gitlab.
I&rsquo;m still in awe of how easy to adopt <a href=https://docs.gitlab.com/ee/ci/>CI/CD</a> using Gitlab.
Kudos to the team!</p><p>To set up CI/CD, you can follow the Gitlab Runner&rsquo;s installation
guide. Or you can use <em>Ansible</em>
<a href=https://github.com/riemers/ansible-gitlab-runner>role</a>
to easily set one up. I prefer the latter since we have many servers to manage.</p><p>First the requirement (<code>requirements.yaml</code>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>roles</span>:
  - <span style=color:#ae81ff>riemers.gitlab-runner</span>
</code></pre></div><p>Then you can use <code>ansible-galaxy</code> to install the role:</p><pre><code>ansible-galaxy install -r requirements.yml
</code></pre><p>A sample playbook (<code>gitlab.yaml</code>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup Gitlab Runner</span>
  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
  <span style=color:#f92672>vars_files</span>:
    - <span style=color:#ae81ff>vars/runner.yaml</span>
  <span style=color:#f92672>roles</span>:
    - { <span style=color:#f92672>role</span>: <span style=color:#ae81ff>riemers.gitlab-runner }</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add gitlab-runner to groups</span>
      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>usermod -aG {{ item }} gitlab-runner</span>
      <span style=color:#f92672>with_items</span>:
        - {{ <span style=color:#ae81ff>ansible_user }}</span>
        - <span style=color:#ae81ff>docker</span>
</code></pre></div><p>Inside <code>vars</code>, I provide some tokens and settings:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>gitlab_runner_coordinator_url</span>: <span style=color:#e6db74>&#34;&lt;gitlab-domain&gt;&#34;</span>
<span style=color:#f92672>gitlab_runner_registration_token</span>: <span style=color:#e6db74>&#34;&lt;token&gt;&#34;</span>
<span style=color:#f92672>gitlab_runner_runners</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;ocr-prod&#34;</span>
    <span style=color:#f92672>executor</span>: <span style=color:#e6db74>&#34;shell&#34;</span>
    <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#34;present&#34;</span>
    <span style=color:#f92672>tags</span>:
      - <span style=color:#ae81ff>prod</span>
    <span style=color:#f92672>docker_privileged</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Then one command to set up:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ansible-playbook gitlab.yml -l prod
</code></pre></div><p>Now my main job is to maintain the <code>.gitlab-ci.yml</code> file to define the
pipeline. Below is the concept code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>variables</span>:
    <span style=color:#f92672>IMAGE</span>: <span style=color:#ae81ff>&lt;image-name&gt;</span>
    <span style=color:#f92672>TEST_DIR</span>: <span style=color:#ae81ff>&lt;test-directory&gt;</span>
    <span style=color:#f92672>STAGING_DIR</span>: <span style=color:#ae81ff>&lt;staging-directory&gt;</span>
    <span style=color:#f92672>PROD_DIR</span>: <span style=color:#ae81ff>&lt;prod-directory&gt;</span>

<span style=color:#f92672>stages</span>:
    - <span style=color:#ae81ff>build</span>
    - <span style=color:#ae81ff>test</span>
    - <span style=color:#ae81ff>deploy</span>

<span style=color:#f92672>build</span>:
    <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
    <span style=color:#f92672>script</span>:
        - <span style=color:#ae81ff>docker build . -t $IMAGE:$CI_COMMIT_TAG</span>
        - <span style=color:#ae81ff>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
        - <span style=color:#ae81ff>docker push $IMAGE:$CI_COMMIT_TAG</span>

<span style=color:#f92672>test</span>:
    <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
    <span style=color:#f92672>script</span>:
        - <span style=color:#ae81ff>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
        - <span style=color:#ae81ff>docker pull $IMAGE:$CI_COMMIT_TAG</span>
        - <span style=color:#ae81ff>cd $TEST_DIR</span>
        - <span style=color:#ae81ff>docker-compose up -d</span>
        - <span style=color:#ae81ff>pytest</span>
        - <span style=color:#ae81ff>docker-compose down</span>

<span style=color:#f92672>staging</span>:
    <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
    <span style=color:#f92672>script</span>:
        - <span style=color:#ae81ff>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
        - <span style=color:#ae81ff>docker pull $IMAGE:$CI_COMMIT_TAG</span>
        - <span style=color:#ae81ff>cd $STAGING_DIR</span>
        - <span style=color:#ae81ff>docker-compose up -d</span>

<span style=color:#f92672>prod</span>:
    <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
    <span style=color:#f92672>script</span>:
        - <span style=color:#ae81ff>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
        - <span style=color:#ae81ff>docker pull $IMAGE:$CI_COMMIT_TAG</span>
        - <span style=color:#ae81ff>cd $PROD_DIR</span>
        - <span style=color:#ae81ff>docker-compose up -d</span>
</code></pre></div><p>The variables with <code>$CI_</code> prefix are predefined variables of our
self-hosted Gitlab code base and image registry. There are many more
predefined variables to support you for the automation process.</p><p>With the simple act of tagging, we can achieve 5-10 releases a day. That&rsquo;s a massive step since we used to release weekly, and the process required various members to join.</p><p>Due to the policy, I can only reveal the concept and some of our code.
However, I hope with the mindset and these tools; you can adapt automation to your team and daily life.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://hiepph.github.io>hiepph</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>